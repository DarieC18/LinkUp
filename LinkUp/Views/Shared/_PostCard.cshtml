@model LinkUp.Application.DTOs.Social.PostFeedItemDto
@using System.Security.Claims

@{
    var currentUserId = User?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    var isMine = string.Equals(Model.AuthorId, currentUserId, StringComparison.Ordinal);

    var currentState = Model.MyReactionIsLike == true
        ? "liked"
        : (Model.MyReactionIsDislike == true ? "disliked" : "none");
}

<article class="card post-card border-0 shadow-sm mb-3"
         data-post-card
         data-post-id="@Model.Id"
         data-current-state="@currentState">
    <div class="card-body">
        <div class="d-flex align-items-center gap-3 mb-2">
            <a asp-controller="Friends"
               asp-action="Posts"
               asp-route-idOrUsername="@Model.AuthorId"
               class="d-inline-block">
                <img src="@(Model.AuthorAvatarPath ?? "/img/default-avatar.png")"
                     class="avatar"
                     alt="Avatar de @Model.AuthorName" />
            </a>

            <div>
                <strong class="fw-semibold">
                    <a asp-controller="Friends"
                       asp-action="Posts"
                       asp-route-idOrUsername="@Model.AuthorId"
                       class="text-decoration-none">
                        @Model.AuthorName
                    </a>
                </strong>
                <div class="text-muted small">@Model.CreatedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
            </div>

            @if (isMine)
            {
                <div class="ms-auto dropdown">
                    <button class="btn btn-sm btn-light" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" asp-controller="Posts" asp-action="Edit" asp-route-id="@Model.Id">
                                <i class="bi bi-pencil"></i> Editar
                            </a>
                        </li>
                        <li>
                            <form method="post"
                                  asp-controller="Posts"
                                  asp-action="Delete"
                                  data-confirm
                                  data-confirm-message="¿Eliminar esta publicación definitivamente?"
                                  data-delete-kind="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button class="dropdown-item text-danger" type="submit">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            }
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.Content))
        {
            <p class="mb-3">@Model.Content</p>
        }

        @if (!string.IsNullOrEmpty(Model.ImagePath) || !string.IsNullOrEmpty(Model.YouTubeVideoId))
        {
            <div class="post-media mb-3">
                @if (!string.IsNullOrEmpty(Model.ImagePath))
                {
                    <img src="@Model.ImagePath" class="img-fluid rounded" alt="Imagen de la publicación" />
                }
                else if (!string.IsNullOrEmpty(Model.YouTubeVideoId))
                {
                    <div class="ratio ratio-16x9">
                        <iframe src="https://www.youtube.com/embed/@(Model.YouTubeVideoId)"
                                title="YouTube video player"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen>
                        </iframe>
                    </div>
                }
            </div>
        }

        @await Html.PartialAsync("~/Views/Shared/_ReactionBar.cshtml", Model)

        <div data-comments data-post-id="@Model.Id">
            <div class="text-muted">Cargando comentarios…</div>
        </div>

        <form asp-controller="Comments" asp-action="Create"
              method="post"
              class="mt-2"
              data-comment-form
              data-post-id="@Model.Id">
            @Html.AntiForgeryToken()
            <input type="hidden" name="PostId" value="@Model.Id" />
            <div class="input-group">
                <input class="form-control" name="Content" placeholder="Escribe un comentario..." required />
                <button class="btn btn-primary">Comentar</button>
            </div>
        </form>
    </div>
</article>
